<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/app/src/main/java/com/example/myapplication/MainActivity.kt">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/src/main/java/com/example/myapplication/MainActivity.kt" />
              <option name="originalContent" value="package com.example.myapplication&#10;&#10;import android.Manifest&#10;import android.app.Activity&#10;import android.content.Context&#10;import android.content.Intent&#10;import android.content.pm.PackageManager&#10;import android.net.Uri&#10;import android.os.Bundle&#10;import android.util.Log&#10;import android.widget.Toast&#10;import androidx.activity.ComponentActivity&#10;import androidx.activity.compose.rememberLauncherForActivityResult&#10;import androidx.activity.compose.setContent&#10;import androidx.activity.result.ActivityResultLauncher&#10;import androidx.activity.result.contract.ActivityResultContracts&#10;import androidx.annotation.OptIn&#10;import androidx.camera.core.*&#10;import androidx.camera.lifecycle.ProcessCameraProvider&#10;import androidx.camera.view.PreviewView&#10;import androidx.compose.foundation.background&#10;import androidx.compose.foundation.border&#10;import androidx.compose.foundation.layout.*&#10;import androidx.compose.foundation.lazy.LazyColumn&#10;import androidx.compose.foundation.lazy.items&#10;import androidx.compose.foundation.shape.CircleShape&#10;import androidx.compose.foundation.shape.RoundedCornerShape&#10;import androidx.compose.material.icons.Icons&#10;import androidx.compose.material.icons.filled.*&#10;import androidx.compose.material.icons.outlined.Info&#10;import androidx.compose.material.icons.outlined.Lock&#10;import androidx.compose.material3.*&#10;import androidx.compose.runtime.*&#10;import androidx.compose.ui.Alignment&#10;import androidx.compose.ui.Modifier&#10;import androidx.compose.ui.draw.clip&#10;import androidx.compose.ui.graphics.Color&#10;import androidx.compose.ui.graphics.vector.ImageVector&#10;import androidx.compose.ui.platform.LocalContext&#10;import androidx.compose.ui.platform.LocalLifecycleOwner&#10;import androidx.compose.ui.text.font.FontWeight&#10;import androidx.compose.ui.text.style.TextAlign&#10;import androidx.compose.ui.unit.dp&#10;import androidx.compose.ui.unit.sp&#10;import androidx.compose.ui.viewinterop.AndroidView&#10;import androidx.compose.ui.zIndex&#10;import androidx.core.content.ContextCompat&#10;import com.example.myapplication.passkey.PasskeyRepository&#10;import com.google.mlkit.vision.barcode.BarcodeScanning&#10;import com.google.mlkit.vision.common.InputImage&#10;import kotlinx.coroutines.launch&#10;import java.util.concurrent.Executors&#10;&#10;// --- KONFIGURACJA KOLORÓW (STYL mOBYWATEL) ---&#10;&#10;val ColorGovBlue = Color(0xFF003399) // Główny granat&#10;val ColorGovBg = Color(0xFFF5F6F7)   // Szare tło&#10;val ColorSuccess = Color(0xFF007E33) // Ciemna zieleń&#10;val ColorError = Color(0xFFCC0000)   // Ciemna czerwień&#10;&#10;// --- REJESTR DOMEN (dla ekranu listy) ---&#10;object TrustedRegistry {&#10;    val domains = listOf(&#10;        &quot;100sekund.gov.pl&quot;, &quot;100sekundwmuzeum.gov.pl&quot;, &quot;1920.gov.pl&quot;, &quot;20lat.gov.pl&quot;,&#10;        &quot;20latwue.gov.pl&quot;, &quot;aan.gov.pl&quot;, &quot;abm.gov.pl&quot;, &quot;abw.gov.pl&quot;, &quot;ac.gov.pl&quot;,&#10;        &quot;ade.gov.pl&quot;, &quot;afs.gov.pl&quot;, &quot;agad.gov.pl&quot;, &quot;aids.gov.pl&quot;, &quot;ai.gov.pl&quot;,&#10;        &quot;akademiacez.gov.pl&quot;, &quot;akademiakopernikanska.gov.pl&quot;, &quot;ak.gov.pl&quot;,&#10;        &quot;aktywnyrodzic.gov.pl&quot;, &quot;aleksandrowkuj.sr.gov.pl&quot;, &quot;ank.gov.pl&quot;,&#10;        &quot;gov.pl&quot;, &quot;podatki.gov.pl&quot;, &quot;pacjent.gov.pl&quot;, &quot;mobywatel.gov.pl&quot;,&#10;        &quot;epuap.gov.pl&quot;, &quot;profil-zaufany.pl&quot;, &quot;zus.pl&quot;, &quot;bip.gov.pl&quot;, &quot;sejm.gov.pl&quot;,&#10;        &quot;prezydent.pl&quot;, &quot;premier.gov.pl&quot;, &quot;otwartedane.gov.pl&quot;, &quot;dane.gov.pl&quot;,&#10;        &quot;cert.pl&quot;, &quot;mf.gov.pl&quot;, &quot;mswia.gov.pl&quot;, &quot;men.gov.pl&quot;, &quot;mz.gov.pl&quot;&#10;    )&#10;}&#10;&#10;// --- WALIDACJA KODÓW FIDO ---&#10;private const val FIDO_PREFIX = &quot;FIDO:/&quot;&#10;&#10;enum class VerificationResult { PASSKEY, INVALID }&#10;enum class PasskeyStatus { NOT_SENT, PENDING, SUCCESS, FAILURE }&#10;enum class Screen { HOME, SCANNER, RESULT, REGISTRY_LIST }&#10;&#10;sealed class PasskeyRegistrationState {&#10;    object Loading : PasskeyRegistrationState()&#10;    object Success : PasskeyRegistrationState()&#10;    data class Error(val message: String) : PasskeyRegistrationState()&#10;}&#10;&#10;data class ScanResultData(val payload: String, val status: VerificationResult, val passkeyStatus: PasskeyStatus = PasskeyStatus.NOT_SENT)&#10;data class Quad&lt;A, B, C, D&gt;(val first: A, val second: B, val third: C, val fourth: D)&#10;&#10;class MainActivity : ComponentActivity() {&#10;    override fun onCreate(savedInstanceState: Bundle?) {&#10;        super.onCreate(savedInstanceState)&#10;        setContent {&#10;            MaterialTheme {&#10;                HackNationApp()&#10;            }&#10;        }&#10;    }&#10;}&#10;&#10;@Composable&#10;fun HackNationApp() {&#10;    val context = LocalContext.current&#10;    val passkeyRepository = remember(context.applicationContext) { PasskeyRepository(context.applicationContext) }&#10;    val coroutineScope = rememberCoroutineScope()&#10;    var passkeyRegistrationState by remember { mutableStateOf&lt;PasskeyRegistrationState&gt;(PasskeyRegistrationState.Loading) }&#10;    var currentScreen by remember { mutableStateOf(Screen.HOME) }&#10;    var scanResult by remember { mutableStateOf(ScanResultData(&quot;&quot;, VerificationResult.INVALID)) }&#10;&#10;    val passkeyLauncher = rememberLauncherForActivityResult(ActivityResultContracts.StartActivityForResult()) { result -&gt;&#10;        val newStatus = when (result.resultCode) {&#10;            Activity.RESULT_OK -&gt; PasskeyStatus.SUCCESS&#10;            Activity.RESULT_CANCELED -&gt; PasskeyStatus.FAILURE&#10;            else -&gt; PasskeyStatus.FAILURE&#10;        }&#10;        scanResult = scanResult.copy(passkeyStatus = newStatus)&#10;        val feedback = if (newStatus == PasskeyStatus.SUCCESS) &quot;Android potwierdził przesłanie passkey&quot; else &quot;Android przerwał lub odrzucił żądanie passkey&quot;&#10;        Toast.makeText(context, feedback, Toast.LENGTH_SHORT).show()&#10;    }&#10;&#10;    fun launchPasskeyRegistration() {&#10;        coroutineScope.launch {&#10;            passkeyRegistrationState = PasskeyRegistrationState.Loading&#10;            val success = passkeyRepository.registerPasskey(context)&#10;            passkeyRegistrationState = if (success) {&#10;                PasskeyRegistrationState.Success&#10;            } else {&#10;                PasskeyRegistrationState.Error(&quot;Nie udało się zainstalować passkey. Spróbuj ponownie.&quot;)&#10;            }&#10;        }&#10;    }&#10;&#10;    LaunchedEffect(passkeyRepository) {&#10;        launchPasskeyRegistration()&#10;    }&#10;&#10;    Scaffold(&#10;        topBar = {&#10;            Box(&#10;                modifier = Modifier.fillMaxWidth().height(60.dp).background(ColorGovBlue),&#10;                contentAlignment = Alignment.CenterStart&#10;            ) {&#10;                Row(verticalAlignment = Alignment.CenterVertically) {&#10;                    Spacer(modifier = Modifier.width(16.dp))&#10;                    Icon(Icons.Default.Security, contentDescription = &quot;Logo&quot;, tint = Color.White)&#10;                    Spacer(modifier = Modifier.width(12.dp))&#10;                    Text(&quot;mObywatel&quot;, color = Color.White, fontSize = 20.sp, fontWeight = FontWeight.Bold)&#10;                }&#10;            }&#10;        }&#10;    ) { paddingValues -&gt;&#10;        Box(modifier = Modifier.padding(paddingValues).fillMaxSize().background(ColorGovBg)) {&#10;            when (currentScreen) {&#10;                Screen.HOME -&gt; HomeScreen(&#10;                    onScanClick = { currentScreen = Screen.SCANNER },&#10;                    onRegistryClick = { currentScreen = Screen.REGISTRY_LIST },&#10;                    registrationState = passkeyRegistrationState,&#10;                    onRetryRegistration = { launchPasskeyRegistration() }&#10;                )&#10;                Screen.SCANNER -&gt; CameraScreen(&#10;                    onCodeScanned = { code -&gt;&#10;                        val (status, passkeyStatus) = handleScannedPayload(context, code, passkeyLauncher)&#10;                        scanResult = ScanResultData(code, status, passkeyStatus)&#10;                        currentScreen = Screen.RESULT&#10;                    },&#10;                    onClose = { currentScreen = Screen.HOME }&#10;                )&#10;                Screen.RESULT -&gt; ResultScreen(&#10;                    data = scanResult,&#10;                    onBack = { currentScreen = Screen.HOME },&#10;                    onRetryPasskey = { payload -&gt;&#10;                        scanResult = scanResult.copy(passkeyStatus = PasskeyStatus.PENDING)&#10;                        val launched = launchPasskeyIntent(context, payload, passkeyLauncher)&#10;                        if (!launched) {&#10;                            scanResult = scanResult.copy(passkeyStatus = PasskeyStatus.FAILURE)&#10;                        }&#10;                    }&#10;                )&#10;                Screen.REGISTRY_LIST -&gt; RegistryListScreen(&#10;                    onBack = { currentScreen = Screen.HOME }&#10;                )&#10;            }&#10;        }&#10;    }&#10;}&#10;&#10;// --- EKRAN 1: HOME (Centrum Akcji) ---&#10;@Composable&#10;fun HomeScreen(onScanClick: () -&gt; Unit, onRegistryClick: () -&gt; Unit, registrationState: PasskeyRegistrationState, onRetryRegistration: () -&gt; Unit) {&#10;    val context = LocalContext.current&#10;    val launcher = rememberLauncherForActivityResult(ActivityResultContracts.RequestPermission()) { granted -&gt;&#10;        if (granted) onScanClick()&#10;    }&#10;&#10;    fun tryOpenScanner() {&#10;        if (ContextCompat.checkSelfPermission(context, Manifest.permission.CAMERA) == PackageManager.PERMISSION_GRANTED) {&#10;            onScanClick()&#10;        } else {&#10;            launcher.launch(Manifest.permission.CAMERA)&#10;        }&#10;    }&#10;&#10;    Column(&#10;        modifier = Modifier.fillMaxSize().padding(24.dp),&#10;        horizontalAlignment = Alignment.CenterHorizontally&#10;    ) {&#10;        PasskeyRegistrationBanner(registrationState, onRetryRegistration)&#10;        Spacer(modifier = Modifier.height(12.dp))&#10;        Text(&quot;Weryfikacja autentyczności&quot;, fontSize = 22.sp, fontWeight = FontWeight.Bold, color = ColorGovBlue, textAlign = TextAlign.Center)&#10;        Spacer(modifier = Modifier.height(8.dp))&#10;        Text(&quot;Upewnij się, że strona należy do rządu RP.&quot;, fontSize = 14.sp, color = Color.Gray, textAlign = TextAlign.Center)&#10;&#10;        Spacer(modifier = Modifier.weight(1f))&#10;&#10;        // GŁÓWNY PRZYCISK (PULSUJĄCY)&#10;        Box(contentAlignment = Alignment.Center, modifier = Modifier.size(280.dp)) {&#10;            Box(modifier = Modifier.size(260.dp).border(1.dp, ColorGovBlue.copy(alpha = 0.1f), CircleShape).background(ColorGovBlue.copy(alpha = 0.03f), CircleShape))&#10;            Surface(&#10;                onClick = { tryOpenScanner() },&#10;                modifier = Modifier.size(200.dp),&#10;                shape = CircleShape,&#10;                color = Color.White,&#10;                shadowElevation = 12.dp,&#10;                border = androidx.compose.foundation.BorderStroke(1.dp, Color.LightGray.copy(alpha = 0.3f))&#10;            ) {&#10;                Column(modifier = Modifier.fillMaxSize(), horizontalAlignment = Alignment.CenterHorizontally, verticalArrangement = Arrangement.Center) {&#10;                    Icon(Icons.Default.QrCodeScanner, contentDescription = null, modifier = Modifier.size(64.dp), tint = ColorGovBlue)&#10;                    Spacer(modifier = Modifier.height(12.dp))&#10;                    Text(&quot;SKANUJ QR&quot;, fontSize = 18.sp, fontWeight = FontWeight.ExtraBold, color = ColorGovBlue, letterSpacing = 1.sp)&#10;                }&#10;            }&#10;        }&#10;&#10;        Spacer(modifier = Modifier.weight(1f))&#10;&#10;        // PRZYCISK REJESTRU&#10;        Card(&#10;            onClick = onRegistryClick,&#10;            shape = RoundedCornerShape(16.dp),&#10;            colors = CardDefaults.cardColors(containerColor = Color.White),&#10;            border = androidx.compose.foundation.BorderStroke(1.dp, ColorGovBlue.copy(alpha = 0.2f)),&#10;            modifier = Modifier.fillMaxWidth().height(60.dp)&#10;        ) {&#10;            Row(modifier = Modifier.fillMaxSize(), verticalAlignment = Alignment.CenterVertically, horizontalArrangement = Arrangement.Center) {&#10;                Icon(Icons.Default.ListAlt, contentDescription = null, tint = ColorGovBlue)&#10;                Spacer(modifier = Modifier.width(12.dp))&#10;                Text(&quot;Przeglądaj rejestr domen .gov.pl&quot;, color = ColorGovBlue, fontWeight = FontWeight.Medium, fontSize = 15.sp)&#10;            }&#10;        }&#10;        Spacer(modifier = Modifier.height(16.dp))&#10;    }&#10;}&#10;&#10;// --- EKRAN 2: KOMPENDIUM (Z Wyszukiwarką) ---&#10;@Composable&#10;fun RegistryListScreen(onBack: () -&gt; Unit) {&#10;    var searchQuery by remember { mutableStateOf(&quot;&quot;) }&#10;    val filteredDomains = remember(searchQuery) {&#10;        if (searchQuery.isBlank()) TrustedRegistry.domains&#10;        else TrustedRegistry.domains.filter { it.contains(searchQuery, ignoreCase = true) }&#10;    }&#10;&#10;    Column(modifier = Modifier.fillMaxSize().background(Color.White)) {&#10;        Surface(shadowElevation = 4.dp, color = Color.White, modifier = Modifier.zIndex(1f)) {&#10;            Column {&#10;                Row(modifier = Modifier.fillMaxWidth().padding(16.dp), verticalAlignment = Alignment.CenterVertically) {&#10;                    IconButton(onClick = onBack) { Icon(Icons.Default.ArrowBack, contentDescription = &quot;Wróć&quot;, tint = ColorGovBlue) }&#10;                    Text(&quot;Rejestr domen gov.pl&quot;, fontSize = 20.sp, fontWeight = FontWeight.Bold, color = ColorGovBlue)&#10;                }&#10;                OutlinedTextField(&#10;                    value = searchQuery,&#10;                    onValueChange = { searchQuery = it },&#10;                    modifier = Modifier.fillMaxWidth().padding(horizontal = 16.dp, vertical = 8.dp),&#10;                    placeholder = { Text(&quot;Szukaj instytucji...&quot;) },&#10;                    leadingIcon = { Icon(Icons.Default.Search, null, tint = Color.Gray) },&#10;                    trailingIcon = { if (searchQuery.isNotEmpty()) IconButton(onClick = { searchQuery = &quot;&quot; }) { Icon(Icons.Default.Close, null, tint = Color.Gray) } },&#10;                    shape = RoundedCornerShape(12.dp),&#10;                    colors = OutlinedTextFieldDefaults.colors(focusedBorderColor = ColorGovBlue, focusedLabelColor = ColorGovBlue)&#10;                )&#10;                Spacer(modifier = Modifier.height(8.dp))&#10;            }&#10;        }&#10;&#10;        LazyColumn(contentPadding = PaddingValues(16.dp), modifier = Modifier.fillMaxSize()) {&#10;            if (filteredDomains.isEmpty()) {&#10;                item {&#10;                    Column(modifier = Modifier.fillMaxWidth().padding(top = 50.dp), horizontalAlignment = Alignment.CenterHorizontally) {&#10;                        Icon(Icons.Default.SearchOff, null, tint = Color.LightGray, modifier = Modifier.size(60.dp))&#10;                        Text(&quot;Brak wyników&quot;, color = Color.Gray)&#10;                    }&#10;                }&#10;            } else {&#10;                items(filteredDomains) { domain -&gt;&#10;                    Card(&#10;                        modifier = Modifier.fillMaxWidth().padding(vertical = 4.dp),&#10;                        shape = RoundedCornerShape(8.dp),&#10;                        colors = CardDefaults.cardColors(containerColor = ColorGovBg.copy(alpha = 0.5f)),&#10;                        border = androidx.compose.foundation.BorderStroke(1.dp, Color.LightGray.copy(alpha = 0.2f))&#10;                    ) {&#10;                        Row(modifier = Modifier.fillMaxWidth().padding(16.dp), verticalAlignment = Alignment.CenterVertically) {&#10;                            Icon(Icons.Default.VerifiedUser, null, tint = ColorSuccess, modifier = Modifier.size(24.dp))&#10;                            Spacer(modifier = Modifier.width(16.dp))&#10;                            Text(domain, fontSize = 16.sp, fontWeight = FontWeight.Medium)&#10;                        }&#10;                    }&#10;                }&#10;            }&#10;        }&#10;    }&#10;}&#10;&#10;// --- EKRAN 3: KAMERA (ML Kit) ---&#10;@Composable&#10;fun CameraScreen(onCodeScanned: (String) -&gt; Unit, onClose: () -&gt; Unit) {&#10;    val context = LocalContext.current&#10;    val lifecycleOwner = LocalLifecycleOwner.current&#10;    var isScanning by remember { mutableStateOf(true) }&#10;&#10;    Box(modifier = Modifier.fillMaxSize().background(Color.Black)) {&#10;        AndroidView(factory = { ctx -&gt;&#10;            val previewView = PreviewView(ctx)&#10;            val cameraProviderFuture = ProcessCameraProvider.getInstance(ctx)&#10;            cameraProviderFuture.addListener({&#10;                val cameraProvider = cameraProviderFuture.get()&#10;                val preview = Preview.Builder().build()&#10;                preview.setSurfaceProvider(previewView.surfaceProvider)&#10;                val imageAnalysis = ImageAnalysis.Builder().setBackpressureStrategy(ImageAnalysis.STRATEGY_KEEP_ONLY_LATEST).build()&#10;                imageAnalysis.setAnalyzer(Executors.newSingleThreadExecutor()) { imageProxy -&gt;&#10;                    processImageProxy(imageProxy) { code -&gt;&#10;                        if (isScanning) {&#10;                            isScanning = false&#10;                            previewView.post { onCodeScanned(code) }&#10;                        }&#10;                    }&#10;                }&#10;                try {&#10;                    cameraProvider.unbindAll()&#10;                    cameraProvider.bindToLifecycle(lifecycleOwner, CameraSelector.DEFAULT_BACK_CAMERA, preview, imageAnalysis)&#10;                } catch (e: Exception) { Log.e(&quot;Camera&quot;, &quot;Error&quot;, e) }&#10;            }, ContextCompat.getMainExecutor(ctx))&#10;            previewView&#10;        }, modifier = Modifier.fillMaxSize())&#10;&#10;        Box(modifier = Modifier.fillMaxSize().background(Color.Black.copy(alpha = 0.6f))) {&#10;            Box(modifier = Modifier.align(Alignment.Center).size(280.dp).background(Color.Transparent).border(3.dp, ColorGovBlue, RoundedCornerShape(12.dp)))&#10;        }&#10;        Text(&quot;Nakieruj kamerę na kod QR&quot;, color = Color.White, modifier = Modifier.align(Alignment.BottomCenter).padding(40.dp))&#10;        IconButton(onClick = onClose, modifier = Modifier.align(Alignment.TopEnd).padding(20.dp)) { Icon(Icons.Default.Close, null, tint = Color.White) }&#10;    }&#10;}&#10;&#10;// --- EKRAN 4: WYNIK (BEZPIECZNE vs ZAGROŻENIE) ---&#10;@Composable&#10;fun ResultScreen(data: ScanResultData, onBack: () -&gt; Unit, onRetryPasskey: (String) -&gt; Unit) {&#10;    val context = LocalContext.current&#10;    val isFidoRequest = data.status == VerificationResult.PASSKEY&#10;&#10;    val hero = when {&#10;        isFidoRequest &amp;&amp; data.passkeyStatus == PasskeyStatus.SUCCESS -&gt; Quad(&#10;            ColorSuccess,&#10;            Icons.Default.CheckCircle,&#10;            &quot;Strona zaufana&quot;,&#10;            &quot;Android potwierdził autoryzację passkey. Możesz kontynuować logowanie.&quot;&#10;        )&#10;        !isFidoRequest -&gt; Quad(&#10;            ColorError,&#10;            Icons.Default.GppBad,&#10;            &quot;Wykryto zagrożenie!&quot;,&#10;            &quot;Ten kod QR nie spełnia wymagań FIDO:/ i nie może zostać użyty.&quot;&#10;        )&#10;        data.passkeyStatus == PasskeyStatus.FAILURE -&gt; Quad(&#10;            ColorError,&#10;            Icons.Default.GppBad,&#10;            &quot;Wykryto zagrożenie!&quot;,&#10;            &quot;Android odrzucił żądanie passkey – potraktuj stronę jako podrobioną.&quot;&#10;        )&#10;        else -&gt; Quad(&#10;            ColorGovBlue,&#10;            Icons.Default.HourglassTop,&#10;            &quot;Trwa weryfikacja&quot;,&#10;            &quot;Żądanie passkey zostało wysłane do Androida. Poczekaj na potwierdzenie.&quot;&#10;        )&#10;    }&#10;&#10;    val (bgColor, icon, title, heroDescription) = hero&#10;    val isSuccess = hero === hero // placeholder removed below&#10;    val showSuccess = isFidoRequest &amp;&amp; data.passkeyStatus == PasskeyStatus.SUCCESS&#10;&#10;    fun retryPasskey() {&#10;        onRetryPasskey(data.payload)&#10;    }&#10;&#10;    fun reportIncident() {&#10;        Toast.makeText(context, &quot;Zgłoszenie wysłane do CERT Polska&quot;, Toast.LENGTH_LONG).show()&#10;        onBack()&#10;    }&#10;&#10;    Column(modifier = Modifier.fillMaxSize().background(ColorGovBg)) {&#10;        Box(&#10;            modifier = Modifier.fillMaxWidth().weight(0.45f).background(bgColor).clip(&#10;                RoundedCornerShape(&#10;                    bottomStart = 30.dp,&#10;                    bottomEnd = 30.dp&#10;                )&#10;            ),&#10;            contentAlignment = Alignment.Center&#10;        ) {&#10;            Column(horizontalAlignment = Alignment.CenterHorizontally) {&#10;                Icon(icon, null, tint = Color.White, modifier = Modifier.size(100.dp))&#10;                Spacer(modifier = Modifier.height(16.dp))&#10;                Text(title, fontSize = 28.sp, fontWeight = FontWeight.Bold, color = Color.White)&#10;                Spacer(modifier = Modifier.height(8.dp))&#10;                Text(&#10;                    when {&#10;                        showSuccess -&gt; &quot;Kod FIDO potwierdzony&quot;&#10;                        data.passkeyStatus == PasskeyStatus.FAILURE -&gt; &quot;Kod FIDO odrzucony&quot;&#10;                        !isFidoRequest -&gt; &quot;Kod bez prefiksu FIDO&quot;&#10;                        else -&gt; &quot;Oczekiwanie na odpowiedź Androida&quot;&#10;                    },&#10;                    fontSize = 14.sp,&#10;                    fontWeight = FontWeight.SemiBold,&#10;                    color = Color.White.copy(alpha = 0.8f),&#10;                    modifier = Modifier.background(&#10;                        Color.Black.copy(alpha = 0.2f),&#10;                        RoundedCornerShape(50)&#10;                    ).padding(horizontal = 16.dp, vertical = 6.dp)&#10;                )&#10;            }&#10;        }&#10;&#10;        Column(modifier = Modifier.weight(0.55f).padding(24.dp), verticalArrangement = Arrangement.SpaceBetween) {&#10;            Text(heroDescription, fontSize = 16.sp, textAlign = TextAlign.Center, color = Color.DarkGray, lineHeight = 24.sp)&#10;            Card(&#10;                colors = CardDefaults.cardColors(containerColor = Color.White),&#10;                elevation = CardDefaults.cardElevation(2.dp),&#10;                modifier = Modifier.fillMaxWidth()&#10;            ) {&#10;                Column(modifier = Modifier.padding(16.dp)) {&#10;                    StatusRow(&quot;Prefiks FIDO:/&quot;, isFidoRequest)&#10;                    Spacer(modifier = Modifier.height(8.dp))&#10;                    PasskeyStatusRow(data.passkeyStatus)&#10;                }&#10;            }&#10;&#10;            Column(modifier = Modifier.fillMaxWidth()) {&#10;                when {&#10;                    showSuccess -&gt; {&#10;                        Button(&#10;                            onClick = onBack,&#10;                            modifier = Modifier.fillMaxWidth().height(50.dp),&#10;                            colors = ButtonDefaults.buttonColors(containerColor = ColorSuccess),&#10;                            shape = RoundedCornerShape(12.dp)&#10;                        ) {&#10;                            Text(&quot;Zakończ i wróć&quot;)&#10;                            Spacer(modifier = Modifier.width(8.dp))&#10;                            Icon(Icons.Default.Check, null, modifier = Modifier.size(18.dp))&#10;                        }&#10;                    }&#10;                    data.passkeyStatus == PasskeyStatus.PENDING || data.passkeyStatus == PasskeyStatus.NOT_SENT -&gt; {&#10;                        Button(&#10;                            onClick = { retryPasskey() },&#10;                            enabled = data.passkeyStatus != PasskeyStatus.PENDING,&#10;                            modifier = Modifier.fillMaxWidth().height(50.dp),&#10;                            colors = ButtonDefaults.buttonColors(containerColor = ColorGovBlue),&#10;                            shape = RoundedCornerShape(12.dp)&#10;                        ) {&#10;                            Text(&quot;Wyślij ponownie do Androida&quot;)&#10;                            Spacer(modifier = Modifier.width(8.dp))&#10;                            Icon(Icons.Default.Refresh, null, modifier = Modifier.size(18.dp))&#10;                        }&#10;                    }&#10;                    else -&gt; {&#10;                        Button(&#10;                            onClick = { reportIncident() },&#10;                            modifier = Modifier.fillMaxWidth().height(50.dp),&#10;                            colors = ButtonDefaults.buttonColors(containerColor = ColorError),&#10;                            shape = RoundedCornerShape(12.dp)&#10;                        ) {&#10;                            Icon(Icons.Default.Report, null, modifier = Modifier.size(18.dp))&#10;                            Spacer(modifier = Modifier.width(8.dp))&#10;                            Text(&quot;Zgłoś próbę oszustwa&quot;)&#10;                        }&#10;                    }&#10;                }&#10;                Spacer(modifier = Modifier.height(12.dp))&#10;                OutlinedButton(onClick = onBack, modifier = Modifier.fillMaxWidth().height(50.dp), shape = RoundedCornerShape(12.dp)) {&#10;                    Text(&quot;Wróć&quot;, color = Color.Gray)&#10;                }&#10;            }&#10;        }&#10;    }&#10;}&#10;&#10;@Composable&#10;fun StatusRow(label: String, isValid: Boolean) {&#10;    Row(verticalAlignment = Alignment.CenterVertically) {&#10;        Icon(if (isValid) Icons.Outlined.Lock else Icons.Default.Close, null, tint = if (isValid) ColorSuccess else ColorError, modifier = Modifier.size(20.dp))&#10;        Spacer(modifier = Modifier.width(12.dp))&#10;        Text(label, fontSize = 14.sp)&#10;    }&#10;}&#10;&#10;@Composable&#10;fun PasskeyStatusRow(status: PasskeyStatus) {&#10;    val (icon, tint, message) = when (status) {&#10;        PasskeyStatus.SUCCESS -&gt; Triple(Icons.Default.Verified, ColorSuccess, &quot;Kod potwierdzony – Android autoryzował passkey&quot;)&#10;        PasskeyStatus.FAILURE -&gt; Triple(Icons.Default.Warning, ColorError, &quot;Niepowodzenie – traktuj stronę jako podrobioną&quot;)&#10;        PasskeyStatus.PENDING -&gt; Triple(Icons.Default.History, ColorGovBlue, &quot;Czekamy na autoryzację Androida&quot;)&#10;        PasskeyStatus.NOT_SENT -&gt; Triple(Icons.Default.HourglassEmpty, Color.Gray, &quot;Żądanie jeszcze nie zostało wysłane&quot;)&#10;    }&#10;    Row(verticalAlignment = Alignment.CenterVertically) {&#10;        Icon(icon, null, tint = tint, modifier = Modifier.size(20.dp))&#10;        Spacer(modifier = Modifier.width(12.dp))&#10;        Text(message, fontSize = 14.sp)&#10;    }&#10;}&#10;&#10;fun handleScannedPayload(context: Context, rawValue: String, launcher: ActivityResultLauncher&lt;Intent&gt;?): Pair&lt;VerificationResult, PasskeyStatus&gt; {&#10;    return if (rawValue.startsWith(FIDO_PREFIX, ignoreCase = true)) {&#10;        val launched = launchPasskeyIntent(context, rawValue, launcher)&#10;        val status = if (launched) PasskeyStatus.PENDING else PasskeyStatus.FAILURE&#10;        VerificationResult.PASSKEY to status&#10;    } else {&#10;        VerificationResult.INVALID to PasskeyStatus.NOT_SENT&#10;    }&#10;}&#10;&#10;fun launchPasskeyIntent(context: Context, payload: String, launcher: ActivityResultLauncher&lt;Intent&gt;? = null): Boolean {&#10;    val intent = Intent(Intent.ACTION_VIEW, Uri.parse(payload)).addFlags(Intent.FLAG_ACTIVITY_SINGLE_TOP)&#10;    return runCatching {&#10;        launcher?.launch(intent) ?: context.startActivity(intent)&#10;    }.onFailure {&#10;        Toast.makeText(context, &quot;Brak aplikacji obsługującej passkey&quot;, Toast.LENGTH_LONG).show()&#10;    }.isSuccess&#10;}&#10;&#10;@OptIn(ExperimentalGetImage::class)&#10;fun processImageProxy(imageProxy: ImageProxy, onCodeScanned: (String) -&gt; Unit) {&#10;    val mediaImage = imageProxy.image&#10;    if (mediaImage != null) {&#10;        val image = InputImage.fromMediaImage(mediaImage, imageProxy.imageInfo.rotationDegrees)&#10;        BarcodeScanning.getClient().process(image).addOnSuccessListener { barcodes -&gt; barcodes.firstOrNull()?.rawValue?.let { onCodeScanned(it) } }.addOnCompleteListener { imageProxy.close() }&#10;    } else { imageProxy.close() }&#10;}&#10;&#10;@Composable&#10;fun PasskeyRegistrationBanner(state: PasskeyRegistrationState, onRetry: () -&gt; Unit) {&#10;    val (bgColor, icon, text, showRetry) = when (state) {&#10;        PasskeyRegistrationState.Loading -&gt; Quad(ColorGovBlue, Icons.Default.HourglassTop, &quot;Trwa instalowanie passkey...&quot;, false)&#10;        PasskeyRegistrationState.Success -&gt; Quad(ColorSuccess, Icons.Default.Verified, &quot;Passkey zainstalowany pomyślnie.&quot;, false)&#10;        is PasskeyRegistrationState.Error -&gt; Quad(ColorError, Icons.Default.Warning, state.message, true)&#10;    }&#10;    Card(&#10;        colors = CardDefaults.cardColors(containerColor = bgColor.copy(alpha = 0.15f)),&#10;        border = androidx.compose.foundation.BorderStroke(1.dp, bgColor),&#10;        shape = RoundedCornerShape(16.dp),&#10;        modifier = Modifier.fillMaxWidth()&#10;    ) {&#10;        Row(modifier = Modifier.padding(16.dp), verticalAlignment = Alignment.CenterVertically) {&#10;            Icon(icon, null, tint = bgColor)&#10;            Spacer(modifier = Modifier.width(12.dp))&#10;            Text(text, color = bgColor, fontWeight = FontWeight.SemiBold, modifier = Modifier.weight(1f))&#10;            if (showRetry) {&#10;                TextButton(onClick = onRetry) { Text(&quot;Ponów&quot;, color = bgColor) }&#10;            }&#10;        }&#10;    }&#10;}&#10;" />
              <option name="updatedContent" value="package com.example.myapplication&#10;&#10;import android.Manifest&#10;import android.app.Activity&#10;import android.content.Context&#10;import android.content.Intent&#10;import android.content.pm.PackageManager&#10;import android.net.Uri&#10;import android.os.Bundle&#10;import android.util.Log&#10;import android.widget.Toast&#10;import androidx.activity.ComponentActivity&#10;import androidx.activity.compose.rememberLauncherForActivityResult&#10;import androidx.activity.compose.setContent&#10;import androidx.activity.result.ActivityResultLauncher&#10;import androidx.activity.result.contract.ActivityResultContracts&#10;import androidx.annotation.OptIn&#10;import androidx.camera.core.*&#10;import androidx.camera.lifecycle.ProcessCameraProvider&#10;import androidx.camera.view.PreviewView&#10;import androidx.compose.foundation.background&#10;import androidx.compose.foundation.border&#10;import androidx.compose.foundation.layout.*&#10;import androidx.compose.foundation.lazy.LazyColumn&#10;import androidx.compose.foundation.lazy.items&#10;import androidx.compose.foundation.shape.CircleShape&#10;import androidx.compose.foundation.shape.RoundedCornerShape&#10;import androidx.compose.material.icons.Icons&#10;import androidx.compose.material.icons.filled.*&#10;import androidx.compose.material.icons.outlined.Info&#10;import androidx.compose.material.icons.outlined.Lock&#10;import androidx.compose.material3.*&#10;import androidx.compose.runtime.*&#10;import androidx.compose.ui.Alignment&#10;import androidx.compose.ui.Modifier&#10;import androidx.compose.ui.draw.clip&#10;import androidx.compose.ui.graphics.Color&#10;import androidx.compose.ui.graphics.vector.ImageVector&#10;import androidx.compose.ui.platform.LocalContext&#10;import androidx.compose.ui.platform.LocalLifecycleOwner&#10;import androidx.compose.ui.text.font.FontWeight&#10;import androidx.compose.ui.text.style.TextAlign&#10;import androidx.compose.ui.unit.dp&#10;import androidx.compose.ui.unit.sp&#10;import androidx.compose.ui.viewinterop.AndroidView&#10;import androidx.compose.ui.zIndex&#10;import androidx.core.content.ContextCompat&#10;import com.example.myapplication.passkey.PasskeyRepository&#10;import com.google.mlkit.vision.barcode.BarcodeScanning&#10;import com.google.mlkit.vision.common.InputImage&#10;import kotlinx.coroutines.launch&#10;import java.util.concurrent.Executors&#10;&#10;// --- KONFIGURACJA KOLORÓW (STYL mOBYWATEL) ---&#10;&#10;val ColorGovBlue = Color(0xFF003399) // Główny granat&#10;val ColorGovBg = Color(0xFFF5F6F7)   // Szare tło&#10;val ColorSuccess = Color(0xFF007E33) // Ciemna zieleń&#10;val ColorError = Color(0xFFCC0000)   // Ciemna czerwień&#10;&#10;// --- REJESTR DOMEN (dla ekranu listy) ---&#10;object TrustedRegistry {&#10;    val domains = listOf(&#10;        &quot;100sekund.gov.pl&quot;, &quot;100sekundwmuzeum.gov.pl&quot;, &quot;1920.gov.pl&quot;, &quot;20lat.gov.pl&quot;,&#10;        &quot;20latwue.gov.pl&quot;, &quot;aan.gov.pl&quot;, &quot;abm.gov.pl&quot;, &quot;abw.gov.pl&quot;, &quot;ac.gov.pl&quot;,&#10;        &quot;ade.gov.pl&quot;, &quot;afs.gov.pl&quot;, &quot;agad.gov.pl&quot;, &quot;aids.gov.pl&quot;, &quot;ai.gov.pl&quot;,&#10;        &quot;akademiacez.gov.pl&quot;, &quot;akademiakopernikanska.gov.pl&quot;, &quot;ak.gov.pl&quot;,&#10;        &quot;aktywnyrodzic.gov.pl&quot;, &quot;aleksandrowkuj.sr.gov.pl&quot;, &quot;ank.gov.pl&quot;,&#10;        &quot;gov.pl&quot;, &quot;podatki.gov.pl&quot;, &quot;pacjent.gov.pl&quot;, &quot;mobywatel.gov.pl&quot;,&#10;        &quot;epuap.gov.pl&quot;, &quot;profil-zaufany.pl&quot;, &quot;zus.pl&quot;, &quot;bip.gov.pl&quot;, &quot;sejm.gov.pl&quot;,&#10;        &quot;prezydent.pl&quot;, &quot;premier.gov.pl&quot;, &quot;otwartedane.gov.pl&quot;, &quot;dane.gov.pl&quot;,&#10;        &quot;cert.pl&quot;, &quot;mf.gov.pl&quot;, &quot;mswia.gov.pl&quot;, &quot;men.gov.pl&quot;, &quot;mz.gov.pl&quot;&#10;    )&#10;}&#10;&#10;// --- WALIDACJA KODÓW FIDO ---&#10;private const val FIDO_PREFIX = &quot;FIDO:/&quot;&#10;&#10;enum class VerificationResult { PASSKEY, INVALID }&#10;enum class PasskeyStatus { NOT_SENT, PENDING, SUCCESS, FAILURE }&#10;enum class Screen { HOME, SCANNER, RESULT, REGISTRY_LIST }&#10;&#10;sealed class PasskeyRegistrationState {&#10;    object Loading : PasskeyRegistrationState()&#10;    object Success : PasskeyRegistrationState()&#10;    data class Error(val message: String) : PasskeyRegistrationState()&#10;}&#10;&#10;data class ScanResultData(val payload: String, val status: VerificationResult, val passkeyStatus: PasskeyStatus = PasskeyStatus.NOT_SENT)&#10;data class Quad&lt;A, B, C, D&gt;(val first: A, val second: B, val third: C, val fourth: D)&#10;&#10;class MainActivity : ComponentActivity() {&#10;    override fun onCreate(savedInstanceState: Bundle?) {&#10;        super.onCreate(savedInstanceState)&#10;        setContent {&#10;            MaterialTheme {&#10;                HackNationApp()&#10;            }&#10;        }&#10;    }&#10;}&#10;&#10;@Composable&#10;fun HackNationApp() {&#10;    val context = LocalContext.current&#10;    val passkeyRepository = remember(context.applicationContext) { PasskeyRepository(context.applicationContext) }&#10;    val coroutineScope = rememberCoroutineScope()&#10;    var passkeyRegistrationState by remember { mutableStateOf&lt;PasskeyRegistrationState&gt;(PasskeyRegistrationState.Loading) }&#10;    val demoResult = remember { ScanResultData(&quot;FIDO:/demo-passkey&quot;, VerificationResult.PASSKEY, PasskeyStatus.SUCCESS) }&#10;    val startOnSuccessPreview = remember { BuildConfig.DEBUG }&#10;    var currentScreen by remember { mutableStateOf(if (startOnSuccessPreview) Screen.RESULT else Screen.HOME) }&#10;    var scanResult by remember { mutableStateOf(if (startOnSuccessPreview) demoResult else ScanResultData(&quot;&quot;, VerificationResult.INVALID)) }&#10;&#10;    val passkeyLauncher = rememberLauncherForActivityResult(ActivityResultContracts.StartActivityForResult()) { result -&gt;&#10;        val newStatus = when (result.resultCode) {&#10;            Activity.RESULT_OK -&gt; PasskeyStatus.SUCCESS&#10;            Activity.RESULT_CANCELED -&gt; PasskeyStatus.FAILURE&#10;            else -&gt; PasskeyStatus.FAILURE&#10;        }&#10;        scanResult = scanResult.copy(passkeyStatus = newStatus)&#10;        val feedback = if (newStatus == PasskeyStatus.SUCCESS) &quot;Android potwierdził przesłanie passkey&quot; else &quot;Android przerwał lub odrzucił żądanie passkey&quot;&#10;        Toast.makeText(context, feedback, Toast.LENGTH_SHORT).show()&#10;    }&#10;&#10;    fun launchPasskeyRegistration() {&#10;        coroutineScope.launch {&#10;            passkeyRegistrationState = PasskeyRegistrationState.Loading&#10;            val success = passkeyRepository.registerPasskey(context)&#10;            passkeyRegistrationState = if (success) {&#10;                PasskeyRegistrationState.Success&#10;            } else {&#10;                PasskeyRegistrationState.Error(&quot;Nie udało się zainstalować passkey. Spróbuj ponownie.&quot;)&#10;            }&#10;        }&#10;    }&#10;&#10;    LaunchedEffect(passkeyRepository) {&#10;        launchPasskeyRegistration()&#10;    }&#10;&#10;    Scaffold(&#10;        topBar = {&#10;            Box(&#10;                modifier = Modifier.fillMaxWidth().height(60.dp).background(ColorGovBlue),&#10;                contentAlignment = Alignment.CenterStart&#10;            ) {&#10;                Row(verticalAlignment = Alignment.CenterVertically) {&#10;                    Spacer(modifier = Modifier.width(16.dp))&#10;                    Icon(Icons.Default.Security, contentDescription = &quot;Logo&quot;, tint = Color.White)&#10;                    Spacer(modifier = Modifier.width(12.dp))&#10;                    Text(&quot;mObywatel&quot;, color = Color.White, fontSize = 20.sp, fontWeight = FontWeight.Bold)&#10;                }&#10;            }&#10;        }&#10;    ) { paddingValues -&gt;&#10;        Box(modifier = Modifier.padding(paddingValues).fillMaxSize().background(ColorGovBg)) {&#10;            when (currentScreen) {&#10;                Screen.HOME -&gt; HomeScreen(&#10;                    onScanClick = { currentScreen = Screen.SCANNER },&#10;                    onRegistryClick = { currentScreen = Screen.REGISTRY_LIST },&#10;                    registrationState = passkeyRegistrationState,&#10;                    onRetryRegistration = { launchPasskeyRegistration() }&#10;                )&#10;                Screen.SCANNER -&gt; CameraScreen(&#10;                    onCodeScanned = { code -&gt;&#10;                        val (status, passkeyStatus) = handleScannedPayload(context, code, passkeyLauncher)&#10;                        scanResult = ScanResultData(code, status, passkeyStatus)&#10;                        currentScreen = Screen.RESULT&#10;                    },&#10;                    onClose = { currentScreen = Screen.HOME }&#10;                )&#10;                Screen.RESULT -&gt; ResultScreen(&#10;                    data = scanResult,&#10;                    onBack = { currentScreen = Screen.HOME },&#10;                    onRetryPasskey = { payload -&gt;&#10;                        scanResult = scanResult.copy(passkeyStatus = PasskeyStatus.PENDING)&#10;                        val launched = launchPasskeyIntent(context, payload, passkeyLauncher)&#10;                        if (!launched) {&#10;                            scanResult = scanResult.copy(passkeyStatus = PasskeyStatus.FAILURE)&#10;                        }&#10;                    }&#10;                )&#10;                Screen.REGISTRY_LIST -&gt; RegistryListScreen(&#10;                    onBack = { currentScreen = Screen.HOME }&#10;                )&#10;            }&#10;        }&#10;    }&#10;}&#10;&#10;// --- EKRAN 1: HOME (Centrum Akcji) ---&#10;@Composable&#10;fun HomeScreen(onScanClick: () -&gt; Unit, onRegistryClick: () -&gt; Unit, registrationState: PasskeyRegistrationState, onRetryRegistration: () -&gt; Unit) {&#10;    val context = LocalContext.current&#10;    val launcher = rememberLauncherForActivityResult(ActivityResultContracts.RequestPermission()) { granted -&gt;&#10;        if (granted) onScanClick()&#10;    }&#10;&#10;    fun tryOpenScanner() {&#10;        if (ContextCompat.checkSelfPermission(context, Manifest.permission.CAMERA) == PackageManager.PERMISSION_GRANTED) {&#10;            onScanClick()&#10;        } else {&#10;            launcher.launch(Manifest.permission.CAMERA)&#10;        }&#10;    }&#10;&#10;    Column(&#10;        modifier = Modifier.fillMaxSize().padding(24.dp),&#10;        horizontalAlignment = Alignment.CenterHorizontally&#10;    ) {&#10;        PasskeyRegistrationBanner(registrationState, onRetryRegistration)&#10;        Spacer(modifier = Modifier.height(12.dp))&#10;        Text(&quot;Weryfikacja autentyczności&quot;, fontSize = 22.sp, fontWeight = FontWeight.Bold, color = ColorGovBlue, textAlign = TextAlign.Center)&#10;        Spacer(modifier = Modifier.height(8.dp))&#10;        Text(&quot;Upewnij się, że strona należy do rządu RP.&quot;, fontSize = 14.sp, color = Color.Gray, textAlign = TextAlign.Center)&#10;&#10;        Spacer(modifier = Modifier.weight(1f))&#10;&#10;        // GŁÓWNY PRZYCISK (PULSUJĄCY)&#10;        Box(contentAlignment = Alignment.Center, modifier = Modifier.size(280.dp)) {&#10;            Box(modifier = Modifier.size(260.dp).border(1.dp, ColorGovBlue.copy(alpha = 0.1f), CircleShape).background(ColorGovBlue.copy(alpha = 0.03f), CircleShape))&#10;            Surface(&#10;                onClick = { tryOpenScanner() },&#10;                modifier = Modifier.size(200.dp),&#10;                shape = CircleShape,&#10;                color = Color.White,&#10;                shadowElevation = 12.dp,&#10;                border = androidx.compose.foundation.BorderStroke(1.dp, Color.LightGray.copy(alpha = 0.3f))&#10;            ) {&#10;                Column(modifier = Modifier.fillMaxSize(), horizontalAlignment = Alignment.CenterHorizontally, verticalArrangement = Arrangement.Center) {&#10;                    Icon(Icons.Default.QrCodeScanner, contentDescription = null, modifier = Modifier.size(64.dp), tint = ColorGovBlue)&#10;                    Spacer(modifier = Modifier.height(12.dp))&#10;                    Text(&quot;SKANUJ QR&quot;, fontSize = 18.sp, fontWeight = FontWeight.ExtraBold, color = ColorGovBlue, letterSpacing = 1.sp)&#10;                }&#10;            }&#10;        }&#10;&#10;        Spacer(modifier = Modifier.weight(1f))&#10;&#10;        // PRZYCISK REJESTRU&#10;        Card(&#10;            onClick = onRegistryClick,&#10;            shape = RoundedCornerShape(16.dp),&#10;            colors = CardDefaults.cardColors(containerColor = Color.White),&#10;            border = androidx.compose.foundation.BorderStroke(1.dp, ColorGovBlue.copy(alpha = 0.2f)),&#10;            modifier = Modifier.fillMaxWidth().height(60.dp)&#10;        ) {&#10;            Row(modifier = Modifier.fillMaxSize(), verticalAlignment = Alignment.CenterVertically, horizontalArrangement = Arrangement.Center) {&#10;                Icon(Icons.Default.ListAlt, contentDescription = null, tint = ColorGovBlue)&#10;                Spacer(modifier = Modifier.width(12.dp))&#10;                Text(&quot;Przeglądaj rejestr domen .gov.pl&quot;, color = ColorGovBlue, fontWeight = FontWeight.Medium, fontSize = 15.sp)&#10;            }&#10;        }&#10;        Spacer(modifier = Modifier.height(16.dp))&#10;    }&#10;}&#10;&#10;// --- EKRAN 2: KOMPENDIUM (Z Wyszukiwarką) ---&#10;@Composable&#10;fun RegistryListScreen(onBack: () -&gt; Unit) {&#10;    var searchQuery by remember { mutableStateOf(&quot;&quot;) }&#10;    val filteredDomains = remember(searchQuery) {&#10;        if (searchQuery.isBlank()) TrustedRegistry.domains&#10;        else TrustedRegistry.domains.filter { it.contains(searchQuery, ignoreCase = true) }&#10;    }&#10;&#10;    Column(modifier = Modifier.fillMaxSize().background(Color.White)) {&#10;        Surface(shadowElevation = 4.dp, color = Color.White, modifier = Modifier.zIndex(1f)) {&#10;            Column {&#10;                Row(modifier = Modifier.fillMaxWidth().padding(16.dp), verticalAlignment = Alignment.CenterVertically) {&#10;                    IconButton(onClick = onBack) { Icon(Icons.Default.ArrowBack, contentDescription = &quot;Wróć&quot;, tint = ColorGovBlue) }&#10;                    Text(&quot;Rejestr domen gov.pl&quot;, fontSize = 20.sp, fontWeight = FontWeight.Bold, color = ColorGovBlue)&#10;                }&#10;                OutlinedTextField(&#10;                    value = searchQuery,&#10;                    onValueChange = { searchQuery = it },&#10;                    modifier = Modifier.fillMaxWidth().padding(horizontal = 16.dp, vertical = 8.dp),&#10;                    placeholder = { Text(&quot;Szukaj instytucji...&quot;) },&#10;                    leadingIcon = { Icon(Icons.Default.Search, null, tint = Color.Gray) },&#10;                    trailingIcon = { if (searchQuery.isNotEmpty()) IconButton(onClick = { searchQuery = &quot;&quot; }) { Icon(Icons.Default.Close, null, tint = Color.Gray) } },&#10;                    shape = RoundedCornerShape(12.dp),&#10;                    colors = OutlinedTextFieldDefaults.colors(focusedBorderColor = ColorGovBlue, focusedLabelColor = ColorGovBlue)&#10;                )&#10;                Spacer(modifier = Modifier.height(8.dp))&#10;            }&#10;        }&#10;&#10;        LazyColumn(contentPadding = PaddingValues(16.dp), modifier = Modifier.fillMaxSize()) {&#10;            if (filteredDomains.isEmpty()) {&#10;                item {&#10;                    Column(modifier = Modifier.fillMaxWidth().padding(top = 50.dp), horizontalAlignment = Alignment.CenterHorizontally) {&#10;                        Icon(Icons.Default.SearchOff, null, tint = Color.LightGray, modifier = Modifier.size(60.dp))&#10;                        Text(&quot;Brak wyników&quot;, color = Color.Gray)&#10;                    }&#10;                }&#10;            } else {&#10;                items(filteredDomains) { domain -&gt;&#10;                    Card(&#10;                        modifier = Modifier.fillMaxWidth().padding(vertical = 4.dp),&#10;                        shape = RoundedCornerShape(8.dp),&#10;                        colors = CardDefaults.cardColors(containerColor = ColorGovBg.copy(alpha = 0.5f)),&#10;                        border = androidx.compose.foundation.BorderStroke(1.dp, Color.LightGray.copy(alpha = 0.2f))&#10;                    ) {&#10;                        Row(modifier = Modifier.fillMaxWidth().padding(16.dp), verticalAlignment = Alignment.CenterVertically) {&#10;                            Icon(Icons.Default.VerifiedUser, null, tint = ColorSuccess, modifier = Modifier.size(24.dp))&#10;                            Spacer(modifier = Modifier.width(16.dp))&#10;                            Text(domain, fontSize = 16.sp, fontWeight = FontWeight.Medium)&#10;                        }&#10;                    }&#10;                }&#10;            }&#10;        }&#10;    }&#10;}&#10;&#10;// --- EKRAN 3: KAMERA (ML Kit) ---&#10;@Composable&#10;fun CameraScreen(onCodeScanned: (String) -&gt; Unit, onClose: () -&gt; Unit) {&#10;    val context = LocalContext.current&#10;    val lifecycleOwner = LocalLifecycleOwner.current&#10;    var isScanning by remember { mutableStateOf(true) }&#10;&#10;    Box(modifier = Modifier.fillMaxSize().background(Color.Black)) {&#10;        AndroidView(factory = { ctx -&gt;&#10;            val previewView = PreviewView(ctx)&#10;            val cameraProviderFuture = ProcessCameraProvider.getInstance(ctx)&#10;            cameraProviderFuture.addListener({&#10;                val cameraProvider = cameraProviderFuture.get()&#10;                val preview = Preview.Builder().build()&#10;                preview.setSurfaceProvider(previewView.surfaceProvider)&#10;                val imageAnalysis = ImageAnalysis.Builder().setBackpressureStrategy(ImageAnalysis.STRATEGY_KEEP_ONLY_LATEST).build()&#10;                imageAnalysis.setAnalyzer(Executors.newSingleThreadExecutor()) { imageProxy -&gt;&#10;                    processImageProxy(imageProxy) { code -&gt;&#10;                        if (isScanning) {&#10;                            isScanning = false&#10;                            previewView.post { onCodeScanned(code) }&#10;                        }&#10;                    }&#10;                }&#10;                try {&#10;                    cameraProvider.unbindAll()&#10;                    cameraProvider.bindToLifecycle(lifecycleOwner, CameraSelector.DEFAULT_BACK_CAMERA, preview, imageAnalysis)&#10;                } catch (e: Exception) { Log.e(&quot;Camera&quot;, &quot;Error&quot;, e) }&#10;            }, ContextCompat.getMainExecutor(ctx))&#10;            previewView&#10;        }, modifier = Modifier.fillMaxSize())&#10;&#10;        Box(modifier = Modifier.fillMaxSize().background(Color.Black.copy(alpha = 0.6f))) {&#10;            Box(modifier = Modifier.align(Alignment.Center).size(280.dp).background(Color.Transparent).border(3.dp, ColorGovBlue, RoundedCornerShape(12.dp)))&#10;        }&#10;        Text(&quot;Nakieruj kamerę na kod QR&quot;, color = Color.White, modifier = Modifier.align(Alignment.BottomCenter).padding(40.dp))&#10;        IconButton(onClick = onClose, modifier = Modifier.align(Alignment.TopEnd).padding(20.dp)) { Icon(Icons.Default.Close, null, tint = Color.White) }&#10;    }&#10;}&#10;&#10;// --- EKRAN 4: WYNIK (BEZPIECZNE vs ZAGROŻENIE) ---&#10;@Composable&#10;fun ResultScreen(data: ScanResultData, onBack: () -&gt; Unit, onRetryPasskey: (String) -&gt; Unit) {&#10;    val context = LocalContext.current&#10;    val isFidoRequest = data.status == VerificationResult.PASSKEY&#10;&#10;    val hero = when {&#10;        isFidoRequest &amp;&amp; data.passkeyStatus == PasskeyStatus.SUCCESS -&gt; Quad(&#10;            ColorSuccess,&#10;            Icons.Default.CheckCircle,&#10;            &quot;Strona zaufana&quot;,&#10;            &quot;Android potwierdził autoryzację passkey. Możesz kontynuować logowanie.&quot;&#10;        )&#10;        !isFidoRequest -&gt; Quad(&#10;            ColorError,&#10;            Icons.Default.GppBad,&#10;            &quot;Wykryto zagrożenie!&quot;,&#10;            &quot;Ten kod QR nie spełnia wymagań FIDO:/ i nie może zostać użyty.&quot;&#10;        )&#10;        data.passkeyStatus == PasskeyStatus.FAILURE -&gt; Quad(&#10;            ColorError,&#10;            Icons.Default.GppBad,&#10;            &quot;Wykryto zagrożenie!&quot;,&#10;            &quot;Android odrzucił żądanie passkey – potraktuj stronę jako podrobioną.&quot;&#10;        )&#10;        else -&gt; Quad(&#10;            ColorGovBlue,&#10;            Icons.Default.HourglassTop,&#10;            &quot;Trwa weryfikacja&quot;,&#10;            &quot;Żądanie passkey zostało wysłane do Androida. Poczekaj na potwierdzenie.&quot;&#10;        )&#10;    }&#10;&#10;    val (bgColor, icon, title, heroDescription) = hero&#10;    val isSuccess = hero === hero // placeholder removed below&#10;    val showSuccess = isFidoRequest &amp;&amp; data.passkeyStatus == PasskeyStatus.SUCCESS&#10;&#10;    fun retryPasskey() {&#10;        onRetryPasskey(data.payload)&#10;    }&#10;&#10;    fun reportIncident() {&#10;        Toast.makeText(context, &quot;Zgłoszenie wysłane do CERT Polska&quot;, Toast.LENGTH_LONG).show()&#10;        onBack()&#10;    }&#10;&#10;    Column(modifier = Modifier.fillMaxSize().background(ColorGovBg)) {&#10;        Box(&#10;            modifier = Modifier.fillMaxWidth().weight(0.45f).background(bgColor).clip(&#10;                RoundedCornerShape(&#10;                    bottomStart = 30.dp,&#10;                    bottomEnd = 30.dp&#10;                )&#10;            ),&#10;            contentAlignment = Alignment.Center&#10;        ) {&#10;            Column(horizontalAlignment = Alignment.CenterHorizontally) {&#10;                Icon(icon, null, tint = Color.White, modifier = Modifier.size(100.dp))&#10;                Spacer(modifier = Modifier.height(16.dp))&#10;                Text(title, fontSize = 28.sp, fontWeight = FontWeight.Bold, color = Color.White)&#10;                Spacer(modifier = Modifier.height(8.dp))&#10;                Text(&#10;                    when {&#10;                        showSuccess -&gt; &quot;Kod FIDO potwierdzony&quot;&#10;                        data.passkeyStatus == PasskeyStatus.FAILURE -&gt; &quot;Kod FIDO odrzucony&quot;&#10;                        !isFidoRequest -&gt; &quot;Kod bez prefiksu FIDO&quot;&#10;                        else -&gt; &quot;Oczekiwanie na odpowiedź Androida&quot;&#10;                    },&#10;                    fontSize = 14.sp,&#10;                    fontWeight = FontWeight.SemiBold,&#10;                    color = Color.White.copy(alpha = 0.8f),&#10;                    modifier = Modifier.background(&#10;                        Color.Black.copy(alpha = 0.2f),&#10;                        RoundedCornerShape(50)&#10;                    ).padding(horizontal = 16.dp, vertical = 6.dp)&#10;                )&#10;            }&#10;        }&#10;&#10;        Column(modifier = Modifier.weight(0.55f).padding(24.dp), verticalArrangement = Arrangement.SpaceBetween) {&#10;            Text(heroDescription, fontSize = 16.sp, textAlign = TextAlign.Center, color = Color.DarkGray, lineHeight = 24.sp)&#10;            Card(&#10;                colors = CardDefaults.cardColors(containerColor = Color.White),&#10;                elevation = CardDefaults.cardElevation(2.dp),&#10;                modifier = Modifier.fillMaxWidth()&#10;            ) {&#10;                Column(modifier = Modifier.padding(16.dp)) {&#10;                    StatusRow(&quot;Prefiks FIDO:/&quot;, isFidoRequest)&#10;                    Spacer(modifier = Modifier.height(8.dp))&#10;                    PasskeyStatusRow(data.passkeyStatus)&#10;                }&#10;            }&#10;&#10;            Column(modifier = Modifier.fillMaxWidth()) {&#10;                when {&#10;                    showSuccess -&gt; {&#10;                        Button(&#10;                            onClick = onBack,&#10;                            modifier = Modifier.fillMaxWidth().height(50.dp),&#10;                            colors = ButtonDefaults.buttonColors(containerColor = ColorSuccess),&#10;                            shape = RoundedCornerShape(12.dp)&#10;                        ) {&#10;                            Text(&quot;Zakończ i wróć&quot;)&#10;                            Spacer(modifier = Modifier.width(8.dp))&#10;                            Icon(Icons.Default.Check, null, modifier = Modifier.size(18.dp))&#10;                        }&#10;                    }&#10;                    data.passkeyStatus == PasskeyStatus.PENDING || data.passkeyStatus == PasskeyStatus.NOT_SENT -&gt; {&#10;                        Button(&#10;                            onClick = { retryPasskey() },&#10;                            enabled = data.passkeyStatus != PasskeyStatus.PENDING,&#10;                            modifier = Modifier.fillMaxWidth().height(50.dp),&#10;                            colors = ButtonDefaults.buttonColors(containerColor = ColorGovBlue),&#10;                            shape = RoundedCornerShape(12.dp)&#10;                        ) {&#10;                            Text(&quot;Wyślij ponownie do Androida&quot;)&#10;                            Spacer(modifier = Modifier.width(8.dp))&#10;                            Icon(Icons.Default.Refresh, null, modifier = Modifier.size(18.dp))&#10;                        }&#10;                    }&#10;                    else -&gt; {&#10;                        Button(&#10;                            onClick = { reportIncident() },&#10;                            modifier = Modifier.fillMaxWidth().height(50.dp),&#10;                            colors = ButtonDefaults.buttonColors(containerColor = ColorError),&#10;                            shape = RoundedCornerShape(12.dp)&#10;                        ) {&#10;                            Icon(Icons.Default.Report, null, modifier = Modifier.size(18.dp))&#10;                            Spacer(modifier = Modifier.width(8.dp))&#10;                            Text(&quot;Zgłoś próbę oszustwa&quot;)&#10;                        }&#10;                    }&#10;                }&#10;                Spacer(modifier = Modifier.height(12.dp))&#10;                OutlinedButton(onClick = onBack, modifier = Modifier.fillMaxWidth().height(50.dp), shape = RoundedCornerShape(12.dp)) {&#10;                    Text(&quot;Wróć&quot;, color = Color.Gray)&#10;                }&#10;            }&#10;        }&#10;    }&#10;}&#10;&#10;@Composable&#10;fun StatusRow(label: String, isValid: Boolean) {&#10;    Row(verticalAlignment = Alignment.CenterVertically) {&#10;        Icon(if (isValid) Icons.Outlined.Lock else Icons.Default.Close, null, tint = if (isValid) ColorSuccess else ColorError, modifier = Modifier.size(20.dp))&#10;        Spacer(modifier = Modifier.width(12.dp))&#10;        Text(label, fontSize = 14.sp)&#10;    }&#10;}&#10;&#10;@Composable&#10;fun PasskeyStatusRow(status: PasskeyStatus) {&#10;    val (icon, tint, message) = when (status) {&#10;        PasskeyStatus.SUCCESS -&gt; Triple(Icons.Default.Verified, ColorSuccess, &quot;Kod potwierdzony – Android autoryzował passkey&quot;)&#10;        PasskeyStatus.FAILURE -&gt; Triple(Icons.Default.Warning, ColorError, &quot;Niepowodzenie – traktuj stronę jako podrobioną&quot;)&#10;        PasskeyStatus.PENDING -&gt; Triple(Icons.Default.History, ColorGovBlue, &quot;Czekamy na autoryzację Androida&quot;)&#10;        PasskeyStatus.NOT_SENT -&gt; Triple(Icons.Default.HourglassEmpty, Color.Gray, &quot;Żądanie jeszcze nie zostało wysłane&quot;)&#10;    }&#10;    Row(verticalAlignment = Alignment.CenterVertically) {&#10;        Icon(icon, null, tint = tint, modifier = Modifier.size(20.dp))&#10;        Spacer(modifier = Modifier.width(12.dp))&#10;        Text(message, fontSize = 14.sp)&#10;    }&#10;}&#10;&#10;fun handleScannedPayload(context: Context, rawValue: String, launcher: ActivityResultLauncher&lt;Intent&gt;?): Pair&lt;VerificationResult, PasskeyStatus&gt; {&#10;    return if (rawValue.startsWith(FIDO_PREFIX, ignoreCase = true)) {&#10;        val launched = launchPasskeyIntent(context, rawValue, launcher)&#10;        val status = if (launched) PasskeyStatus.PENDING else PasskeyStatus.FAILURE&#10;        VerificationResult.PASSKEY to status&#10;    } else {&#10;        VerificationResult.INVALID to PasskeyStatus.NOT_SENT&#10;    }&#10;}&#10;&#10;fun launchPasskeyIntent(context: Context, payload: String, launcher: ActivityResultLauncher&lt;Intent&gt;? = null): Boolean {&#10;    val intent = Intent(Intent.ACTION_VIEW, Uri.parse(payload)).addFlags(Intent.FLAG_ACTIVITY_SINGLE_TOP)&#10;    return runCatching {&#10;        launcher?.launch(intent) ?: context.startActivity(intent)&#10;    }.onFailure {&#10;        Toast.makeText(context, &quot;Brak aplikacji obsługującej passkey&quot;, Toast.LENGTH_LONG).show()&#10;    }.isSuccess&#10;}&#10;&#10;@OptIn(ExperimentalGetImage::class)&#10;fun processImageProxy(imageProxy: ImageProxy, onCodeScanned: (String) -&gt; Unit) {&#10;    val mediaImage = imageProxy.image&#10;    if (mediaImage != null) {&#10;        val image = InputImage.fromMediaImage(mediaImage, imageProxy.imageInfo.rotationDegrees)&#10;        BarcodeScanning.getClient().process(image).addOnSuccessListener { barcodes -&gt; barcodes.firstOrNull()?.rawValue?.let { onCodeScanned(it) } }.addOnCompleteListener { imageProxy.close() }&#10;    } else { imageProxy.close() }&#10;}&#10;&#10;@Composable&#10;fun PasskeyRegistrationBanner(state: PasskeyRegistrationState, onRetry: () -&gt; Unit) {&#10;    val (bgColor, icon, text, showRetry) = when (state) {&#10;        PasskeyRegistrationState.Loading -&gt; Quad(ColorGovBlue, Icons.Default.HourglassTop, &quot;Trwa instalowanie passkey...&quot;, false)&#10;        PasskeyRegistrationState.Success -&gt; Quad(ColorSuccess, Icons.Default.Verified, &quot;Passkey zainstalowany pomyślnie.&quot;, false)&#10;        is PasskeyRegistrationState.Error -&gt; Quad(ColorError, Icons.Default.Warning, state.message, true)&#10;    }&#10;    Card(&#10;        colors = CardDefaults.cardColors(containerColor = bgColor.copy(alpha = 0.15f)),&#10;        border = androidx.compose.foundation.BorderStroke(1.dp, bgColor),&#10;        shape = RoundedCornerShape(16.dp),&#10;        modifier = Modifier.fillMaxWidth()&#10;    ) {&#10;        Row(modifier = Modifier.padding(16.dp), verticalAlignment = Alignment.CenterVertically) {&#10;            Icon(icon, null, tint = bgColor)&#10;            Spacer(modifier = Modifier.width(12.dp))&#10;            Text(text, color = bgColor, fontWeight = FontWeight.SemiBold, modifier = Modifier.weight(1f))&#10;            if (showRetry) {&#10;                TextButton(onClick = onRetry) { Text(&quot;Ponów&quot;, color = bgColor) }&#10;            }&#10;        }&#10;    }&#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>